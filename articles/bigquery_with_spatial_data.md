---
title: "Bigqueryで始める地理空間データ処理"
emoji: "🗺"
type: "tech" # tech: 技術記事 / idea: アイデア
topics: ["Bigquery", "Spatial Data", "GCP"]
published: false
---

# TL;DR

# はじめに
## 目的
- Bigqueryで基本的な地理空間データを行えるということを知りましたので、どのようなことができるのか検証し、利用ケースを考えていきたいと思います。


## 前提事項
- 有料契約をしているGCPプロジェクトがある
- BigQueryにアクセスできる権限がある
- 地理空間データについて基本的な理解がある
- GCPのBigQuery Geo Vizツールを使用するための基本的な知識がある


## 対象読者
- 地理空間データをCloudでも扱いたい方
- BigQueryを使って地理空間データを分析したい方
- 地理情報システム(GIS)に関連するプロジェクトを扱っている方
- 地理空間データをビジュアライズする方法を探している方


# 地理空間データとは
[IBMさんの記事](https://www.ibm.com/jp-ja/topics/geospatial-data)によると、地理空間データは、地表上または地表近くの場所にあるオブジェクト、イベント、またはその他の特徴を記述する情報で、通常、位置情報（通常、地球上の座標）と属性情報（関係する物体、事象、現象の特徴）に時間情報（位置と属性が存在する時間または寿命）を組み合わせたものだそうです。

自分の理解では、緯度や経度のような位置の情報と、その位置に付随する何かしらのデータを持っている情報のことを地理空間データと考えています。

代表的な地理空間データには、GPS（全地球測位システム）や空中写真データ、人工衛星等による観測データ、道路や河川などの台帳データ、人口や農業などの統計データなどがあります。

これらの地理空間データを実際分析するときには、 **『Geographic Information System（GIS）』**という分析用のソフトウェアを一般的に利用します。

よく利用されるのが[QGIS](https://www.qgis.org/ja/site/about/index.html)や[ArcGIS](https://resources.arcgis.com/ja/help/getting-started/articles/026n00000014000000.htm)といった無料のものや有料のものが利用されます。

使い方としては、地理空間データをレイヤーと呼ばれる層として扱い、それらを重ね合わせることで空間的な解析を行います。

具体的なイメージとしては下記のようなものになります。

![image](/images/001026409.gif)
*[国土交通省 地理空間情報ページより](https://www.mlit.go.jp/tochi_fudousan_kensetsugyo/chirikukannjoho/tochi_fudousan_kensetsugyo_tk1_000041.html)*


複数の地理空間データの層を重ねることで1つの情報だけでは発見できなかったインサイトを見つけることができるようになったりします。
複雑なものでは2桁のレイヤーを重ね合わせ分析したりします。

また、単純に重ね合わせるだけでなく、地理空間データの**投影変換**も必要になるケースが多いです。（今回は投影変換（空間座標変換）には触れません。興味がある方は[こちら](https://gis-oer.github.io/gitbook/book/materials/08/08.html)）

そして、上記のような地理空間データをなんとBigqueryでも行えるということを最近知りました（[資料](https://cloud.google.com/bigquery/docs/geospatial-data?hl=ja)）。

無料であるQGISといったGISソフトウェアは、自分のPCスペックに依存するものも多く、レイヤーが増えたり、重たい処理を実行した際、時間がかかったりフリーズしたりするので、重たい処理の実行などでCloudのパワーを利用できるのではと期待しています。

一方、調べを進めると、Bigqueryでは現状基本的な地理空間処理のみ行えるらしく、できるといってもできないこともあるといった状況のようです。

# Bigqueryでできること・できないこと 
次にBiguqeryでできること・できないことを表形式でまとめていきたいと思います。

下記表のような状況となっているようです。

| できること | できないこと |
| --- | --- |
| 地理空間データのストレージとクエリ | 複雑な地理空間分析の制限 |
| 標準的な地理空間関数のサポート | 地理空間データタイプの制限 |
| 大規模な地理空間データセットの分析 | 測地系の変更 |
| 他GCPサービスとの連携で地理空間データの可視化 (Looker Studio, BigQuery Geo Viz, Google Earth Engine) |  |

[こちら](https://cloud.google.com/bigquery/docs/reference/standard-sql/geography_functions)がBigqueryでサポートされている地理空間関数一覧のドキュメントになりますが、逆に言えば、ここにない処理はBigqueryでは実行できないということになります。

例えば、地理空間データからメッシュ化した別の地理空間データの作成や複雑な複数の地理空間データ間関係処理を行うことができません。

複雑な処理などBigqueryにできないことは他のGISツールに頼り、できることはBigqueryに強力なコンピュートリソースを利用し処理していくというスタイルがいいかもしれないですね。

では次に実際にBigqueryでどのように地理空間データを扱うのか公式のチュートリアルを再現していきたいと思います。

# 地理空間データの処理・可視化（チュートリアル編）


# まとめ
- Bigqueryでも地理空間データを扱える！
- 2点間の距離計算などめちゃくちゃ高速
- 測地系を変えられないなどあるため、他のGISツールと組み合わせての利用が良さそう
- BigQuery Geo Vizはクエリだけで可視化できて便利
